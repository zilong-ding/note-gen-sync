# RAG学习

## RAG定义

在自然语言处理领域，大型语言模型(LLM)如GPT-3、BERT等已经取得了显著的进展，它们能够生成连贯、自然的文本，回答问题，并执行其他复杂的语言任务。然而，这些模型存在一些固有的局限性，如“模型幻觉问题”、“时效性问题”和“数据安全问题”。为了克服这些限制，检索增强生成(RAG)技术应运而生。

![2025-09-16_08-15.jpg](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/01ee858c-5483-44ac-b119-8673cc24b5fb.jpeg)

RAG技术结合了大型语言模型的强大生成能力和检索系统的精确性。它允许模型在生成文本时，从外部知识库中检索相关信息，从而提高生成内容的准确性、相关性和时效性。这种方法不仅增强了模型的回答能力，还减少了生成错误信息的风险。

## RAG常见流程

![政企问答项目RAG流程](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/6caead23-9836-469a-b35b-9f0f42f05802.jpeg)

![个人知识库RAG流程](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/f4cdcab4-499a-465b-8a73-a064d3f94d4a.jpeg)

从上述流程中我们可以看到RAG中常见功能部分有文件解析功能、切片划分功能、向量嵌入功能、查询改写功能、路由功能、数据库、多路召回功能、排序功能、大模型回答功能。


## RAG中功能模块

### 文件解析功能

现实生活中我们常见的文件格式有文本(txt)，word文档，pdf文档，md文档。文本解析就是将文档中的内容（文字，图片，表格等信息）提取出来。这里比较困难的是pdf文档解析。

为了解析文件我们可以使用如下技术：

* pdfplumber：pdf文件文本提取和图片提取
* 深度学习的方法：ocr等技术，paddle-ocr，pdf2md
* 多模态大模型的方法：qwen-vl等

![2025-09-16_08-41.jpg](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/347f5f4b-67fd-47ed-8c83-a92cba387a00.jpeg)

### 切片划分功能

RAG技术中划分chunk是为了更好地适应大模型的处理能力，提高检索和生成的效率和准确性，以及优化内容的相关性。

**从大模型输入角度模型**

> 在预训练过程中通常有上下文长度限制，如果输入的文本超过这个长度，超出部分会被丢弃，从而影响模型的性能表现。因此，需要将长文档分割成小块，以适应模型的上下文窗口。

**从语义表示的差异性角度**

> 长文档中各个片段的语义可能存在较大差异，如果将整个文档作为一个整体进行知识检索，会导致语义杂揉，影响检索效果。将长文档切分成多个小块，可以使得每个小块内部表意一致，块之间表意存在多样性，从而更充分地发挥知识检索的作用。

**划分Chunk的注意事项**

在进行chunk划分时，需要保留每个chunk的原始内容来源信息，这包括但不限于：

> 页面编号：记录每个chuk来自文档的哪一页，有助于在需要时快速定位原始信息。
> 文档标识：为每个文档分配一个唯一的标识符，以便在检索时能够准确引用。
> 版本控制：如果文档会更新，记录cunk对应的文档版本，确保内容的一致性和准确性。

随着时间的推移，原始文档可能会更新或修改（可能使用新的文档处理方法重新划分chuk)。因此，在划分chunk时需要考虑：

> 更新策略：制定一个清晰的策略，以确定何时以及如何更新chunk,以保持信息的最新性。
> 版本兼容性：确保新l旧版本的chunk能够兼容，或者能够明确区分不同版本的chunk。

此外chunk之间的顺序可能对理解整个文档至关重要：

> 顺序标记：为每个chuk分配顺序编号或时间戳，以保持它们的逻辑顺序。
> 顺序检索：在检索时，确保能够按照正确的顺序检索和展示chunk。



**常用切片划分的策略如下**：

1. 固定大小：设置100个字符为一个chunk
2. 滑动窗口：在固定大小的情况下加入overlap
3. 按照文档结构：先划分为段落，再划分为句子
4. 递归分块：先划分章节、再划分段落、句子
5. 语义分块：将含义相近的句子划分到一个chunk
6. 大模型分块：写一个提示词，让大模型分块；
7. Late chunking:提取token特征，对chunk tokensi进行pooling;

![2025-09-16_08-50.jpg](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/79b08918-afc9-4e22-a7ed-13f45e3aeadd.jpeg)


#### Late chunking

![2025-09-16_08-56.jpg](https://cdn.jsdelivr.net/gh/zilong-ding/note-gen-image-sync@main/d3420337-732c-40aa-a4cd-2b0f6ab0b564.jpeg)





#### 评价Chunk划分方法

**分块归因(Chunk Attribution)**

> 分块归因用于评估每个检索到的分块是否对模型的响应产生了影响。它使用一个二元指标，将每个分块归类为“有影响”（(Attributed)或“无影响”(Not Attributed)。分块归因与分块利用率(Chunk Utilization)密切相关，其中归因确定分块是否对响应产生了影响，而利用率衡量分块文本在影响中所占的程度。只有被归为“有影响”的分块才能有大于零的利用率得分。

**分块利用率(Chunk Utilization)**

> 分块利用率衡量每个检索到的分块中有多少文本对模型的响应产生了影响。这个指标的范围是 0到1，其中1表示整个分块影响了响应，而较低的值，如0.5，则表示存在“无关”文本，这部分文本并未对响应产生影响。分块利用率与分块归因紧密相关，归因确定分块是否影响了响应，而利用率衡量分块文本在影响中所占的部分。只有被归为“有影响”的分块才能有大于零的利用率得分。







### 向量嵌入功能



### 查询改写功能



### 路由功能


### 数据库


### 多路召回功能


### 重排序


### 大模型功能
